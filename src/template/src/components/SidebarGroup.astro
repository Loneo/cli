---
import type { SidebarGroup } from '../types/config';
import { createLink, isLinkActive } from '../utils/url';

interface Props {
  group: SidebarGroup;
  currentPath: string;
}

const { group, currentPath } = Astro.props;

// Generate a unique ID for this group (for localStorage key)
const groupId = group.label.toLowerCase().replace(/\s+/g, '-');

const isActive = (item: any) => {
  const itemPath = item.href || `/${item.slug}`;
  const fullItemPath = createLink(itemPath);
  return isLinkActive(fullItemPath, currentPath);
};

// Check if any item in this group is active (for auto-expand)
const hasActiveItem = group.items?.some((item) => isActive(item)) ?? false;
---

<div class="sidebar-group" data-group-id={groupId} data-has-active={hasActiveItem}>
  <button class="sidebar-group-header w-full flex items-center justify-between cursor-pointer hover:text-foreground transition-colors" aria-expanded="true">
    <h3 class="m-0 text-xs">{group.label}</h3>
    <svg class="sidebar-chevron w-4 h-4 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>
  
  <ul class="sidebar-group-items list-none m-0 p-0 space-y-1 overflow-hidden transition-all duration-200">
    {group.items?.map((item) => {
        const itemHref = item.href || `/${item.slug}`;
        const fullHref = createLink(itemHref);
        const active = isActive(item);
        return (
        <li>
            <a 
            href={fullHref}
            class={active ? 'sidebar-link sidebar-link-active' : 'sidebar-link'}
            aria-current={active ? 'page' : undefined}
            >
            <span>{item.label}</span>
            </a>
        </li>
        );
    })}
  </ul>
</div>

<style>
  @reference "../styles/global.css";
  .sidebar-group.collapsed .sidebar-group-items {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
  }
  
  .sidebar-group:not(.collapsed) .sidebar-group-items {
    max-height: 500px;
    opacity: 1;
    margin-top: 0.25rem;
  }
  
  .sidebar-group.collapsed .sidebar-chevron {
    transform: rotate(-90deg);
  }
</style>

<script>
  // Initialize collapsible sidebar groups
  function initSidebarGroups() {
    document.querySelectorAll('.sidebar-group').forEach((el) => {
      const group = el as HTMLElement;
      const groupId = group.dataset.groupId;
      const hasActive = group.dataset.hasActive === 'true';
      const storageKey = `sidebar-${groupId}`;
      const header = group.querySelector('.sidebar-group-header') as HTMLButtonElement;
      
      // Check localStorage for saved state, default to expanded if has active item
      const savedState = localStorage.getItem(storageKey);
      const isCollapsed = savedState ? savedState === 'collapsed' : false;
      
      // If there's an active item, always expand
      if (hasActive) {
        group.classList.remove('collapsed');
        header?.setAttribute('aria-expanded', 'true');
      } else if (isCollapsed) {
        group.classList.add('collapsed');
        header?.setAttribute('aria-expanded', 'false');
      }
      
      // Toggle on click
      header?.addEventListener('click', () => {
        const isNowCollapsed = group.classList.toggle('collapsed');
        header.setAttribute('aria-expanded', String(!isNowCollapsed));
        localStorage.setItem(storageKey, isNowCollapsed ? 'collapsed' : 'expanded');
      });
    });
  }
  
  // Run on page load and after View Transitions
  initSidebarGroups();
  document.addEventListener('astro:page-load', initSidebarGroups);
</script>
