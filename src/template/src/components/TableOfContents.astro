---
// TableOfContents component - displays headings from the page
---

<aside class="toc">
  <div class="toc-header">
    <span class="toc-title">On This Page</span>
  </div>
  <nav class="toc-nav" id="toc-nav">
    {/* TOC will be populated by client-side script */}
  </nav>
</aside>

<style is:global>
  /* Component styles override global.css positioning */
  @reference '../styles/global.css';
  #toc-nav {
    padding-top: 1rem;
  }
  
  .toc-header {
    margin-bottom: 0.75rem;
  }
  
  .toc-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    @apply text-muted-foreground;
  }
  
  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .toc-item {
    margin: 0;
  }
  
  /* Level-based indentation */
  .toc-h2 .toc-link { padding-left: 0; }
  .toc-h3 .toc-link { padding-left: 0.75rem; }
  .toc-h4 .toc-link { padding-left: 1.5rem; }
  
  .toc-link {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    line-height: 1.5;
    @apply text-muted-foreground;
    text-decoration: none;
    transition: all 0.15s ease;
  }
  
  .toc-link:hover {
    @apply text-muted-foreground bg-sidebar-accent/30 border-l-sidebar-primary/50;
    border-radius: 0 var(--radius) var(--radius) 0;
  }
  
  .toc-link.active {
    @apply text-muted-foreground bg-muted/40 rounded border-l-3 border-sidebar-primary pl-3;
    font-weight: 600;
  }
  
  .toc-empty {
    font-size: 0.8rem;
    color: oklch(var(--muted-foreground));
    font-style: italic;
  }
</style>

<script>
  function initTOC() {
    const article = document.querySelector('.docs-prose');
    const tocNav = document.getElementById('toc-nav');
    
    if (!article || !tocNav) return;
    
    // Clear existing
    tocNav.innerHTML = '';
    
    const headings = Array.from(article.querySelectorAll('h2'));
    
    if (headings.length === 0) {
      tocNav.innerHTML = '<p class="toc-empty">No headings</p>';
      return;
    }
    
    const list = document.createElement('ul');
    list.className = 'toc-list';
    
    // Store heading data for scroll spy
    const headingData: { id: string; top: number; link: HTMLAnchorElement }[] = [];
    
    headings.forEach((heading, i) => {
      if (!heading.id) heading.id = `section-${i}`;
      
      const li = document.createElement('li');
      li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;
      
      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.className = 'toc-link';
      a.textContent = heading.textContent || '';
      
      headingData.push({
        id: heading.id,
        top: 0,
        link: a
      });
      
      // Smooth scroll
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.getElementById(heading.id);
        if (target) {
          const top = target.getBoundingClientRect().top + window.scrollY - 100;
          window.scrollTo({ top, behavior: 'smooth' });
          history.pushState(null, '', `#${heading.id}`);
          
          // Immediately mark as active
          headingData.forEach(h => h.link.classList.remove('active'));
          a.classList.add('active');
        }
      });
      
      li.appendChild(a);
      list.appendChild(li);
    });
    
    tocNav.appendChild(list);
    
    // Mark first item as active initially
    if (headingData.length > 0) {
      headingData[0].link.classList.add('active');
    }
    
    // Scroll spy
    let ticking = false;
    
    const updateActiveLink = () => {
      const scrollY = window.scrollY + 150;
      
      let activeIndex = 0;
      headings.forEach((h, i) => {
        const rect = h.getBoundingClientRect();
        const top = rect.top + window.scrollY;
        if (scrollY >= top) {
          activeIndex = i;
        }
      });
      
      headingData.forEach((h, i) => {
        if (i === activeIndex) {
          h.link.classList.add('active');
        } else {
          h.link.classList.remove('active');
        }
      });
      
      ticking = false;
    };
    
    const onScroll = () => {
      if (!ticking) {
        requestAnimationFrame(updateActiveLink);
        ticking = true;
      }
    };
    
    window.addEventListener('scroll', onScroll, { passive: true });
    updateActiveLink();
  }
  
  // Initialize
  initTOC();
  document.addEventListener('astro:page-load', initTOC);
</script>
