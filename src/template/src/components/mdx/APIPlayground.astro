---
/**
 * APIPlayground - Interactive API testing component
 * Allows users to test API endpoints directly from documentation
 * Usage: <APIPlayground method="GET" path="/users/{id}" baseUrl="https://api.example.com" />
 */
interface Props {
  method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
  path: string;
  baseUrl?: string;
}

const { method, path, baseUrl = '' } = Astro.props;

const methodColors: Record<string, string> = {
  GET: 'bg-emerald-500',
  POST: 'bg-blue-500',
  PUT: 'bg-amber-500',
  PATCH: 'bg-orange-500',
  DELETE: 'bg-red-500',
};

const methodColor = methodColors[method] || 'bg-gray-500';
const playgroundId = `playground-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="api-playground" id={playgroundId} data-method={method} data-path={path} data-base-url={baseUrl}>
  <div class="playground-header">
    <span class={`playground-method ${methodColor}`}>{method}</span>
    <div class="playground-url-container">
      <input 
        type="text" 
        class="playground-base-url" 
        placeholder="Base URL" 
        value={baseUrl}
      />
      <code class="playground-path">{path}</code>
    </div>
    <button class="playground-send-btn">
      Send
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m22 2-7 20-4-9-9-4Z"/>
        <path d="M22 2 11 13"/>
      </svg>
    </button>
  </div>
  
  <div class="playground-body">
    <div class="playground-tabs">
      <button class="playground-tab active" data-tab="params">Params</button>
      <button class="playground-tab" data-tab="headers">Headers</button>
      <button class="playground-tab" data-tab="body">Body</button>
    </div>
    
    <div class="playground-tab-content active" data-content="params">
      <div class="playground-params">
        <div class="playground-param-row">
          <input type="text" placeholder="Key" class="playground-param-key" />
          <input type="text" placeholder="Value" class="playground-param-value" />
          <button class="playground-param-remove">×</button>
        </div>
      </div>
      <button class="playground-add-param">+ Add Parameter</button>
    </div>
    
    <div class="playground-tab-content" data-content="headers">
      <div class="playground-headers">
        <div class="playground-param-row">
          <input type="text" placeholder="Header" class="playground-param-key" value="Content-Type" />
          <input type="text" placeholder="Value" class="playground-param-value" value="application/json" />
          <button class="playground-param-remove">×</button>
        </div>
      </div>
      <button class="playground-add-header">+ Add Header</button>
    </div>
    
    <div class="playground-tab-content" data-content="body">
      <textarea class="playground-body-input" placeholder='{"key": "value"}'></textarea>
    </div>
  </div>
  
  <div class="playground-response hidden">
    <div class="playground-response-header">
      <span class="playground-response-title">Response</span>
      <span class="playground-status"></span>
      <span class="playground-time"></span>
    </div>
    <pre class="playground-response-body"><code></code></pre>
  </div>
</div>

<style>
  @reference "../../styles/global.css";
  .api-playground {
    @apply my-6 rounded border border-border bg-card overflow-hidden;
  }
  
  .playground-header {
    @apply flex items-center gap-2 p-3 bg-muted/50 border-b border-border;
  }
  
  .playground-method {
    @apply px-3 py-1.5 text-xs font-bold text-white uppercase rounded;
  }
  
  .playground-url-container {
    @apply flex-1 flex items-center gap-1 overflow-hidden;
  }
  
  .playground-base-url {
    @apply w-40 px-2 py-1.5 text-xs bg-background border border-border rounded text-foreground;
    @apply focus:outline-none focus:ring-1 focus:ring-ring;
  }
  
  .playground-path {
    @apply text-sm font-mono text-foreground truncate;
  }
  
  .playground-send-btn {
    @apply flex items-center gap-2 px-4 py-1.5 text-sm font-medium text-primary-foreground bg-primary rounded;
    @apply hover:opacity-90 transition-opacity;
  }
  
  .playground-body {
    @apply p-3;
  }
  
  .playground-tabs {
    @apply flex gap-1 mb-3;
  }
  
  .playground-tab {
    @apply px-3 py-1.5 text-xs font-medium text-muted-foreground rounded;
    @apply hover:text-foreground hover:bg-muted transition-colors;
  }
  
  .playground-tab.active {
    @apply text-foreground bg-muted;
  }
  
  .playground-tab-content {
    @apply hidden;
  }
  
  .playground-tab-content.active {
    @apply block;
  }
  
  .playground-params, .playground-headers {
    @apply space-y-2;
  }
  
  .playground-param-row {
    @apply flex gap-2;
  }
  
  .playground-param-key, .playground-param-value {
    @apply flex-1 px-2 py-1.5 text-sm bg-background border border-border rounded text-foreground;
    @apply focus:outline-none focus:ring-1 focus:ring-ring;
  }
  
  .playground-param-remove {
    @apply w-8 h-8 flex items-center justify-center text-muted-foreground hover:text-destructive;
    @apply rounded hover:bg-muted transition-colors;
  }
  
  .playground-add-param, .playground-add-header {
    @apply mt-2 text-xs text-primary hover:underline;
  }
  
  .playground-body-input {
    @apply w-full h-32 px-3 py-2 text-sm font-mono bg-background border border-border rounded text-foreground;
    @apply focus:outline-none focus:ring-1 focus:ring-ring resize-none;
  }
  
  .playground-response {
    @apply border-t border-border;
  }
  
  .playground-response.hidden {
    display: none;
  }
  
  .playground-response-header {
    @apply flex items-center gap-3 px-3 py-2 bg-muted/50;
  }
  
  .playground-response-title {
    @apply text-sm font-semibold text-foreground;
  }
  
  .playground-status {
    @apply px-2 py-0.5 text-xs font-mono rounded;
  }
  
  .playground-status.success {
    @apply bg-emerald-500/10 text-emerald-500;
  }
  
  .playground-status.error {
    @apply bg-red-500/10 text-red-500;
  }
  
  .playground-time {
    @apply text-xs text-muted-foreground;
  }
  
  .playground-response-body {
    @apply p-3 text-sm font-mono overflow-x-auto bg-muted/30 m-0;
  }
  
  .playground-response-body code {
    @apply text-foreground !bg-transparent !p-0 !border-0;
  }
</style>

<script>
  function initPlayground(container: HTMLElement) {
    const methodEl = container.dataset.method;
    const pathEl = container.dataset.path;
    
    // Tab switching
    const tabs = container.querySelectorAll('.playground-tab');
    const contents = container.querySelectorAll('.playground-tab-content');
    
    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const targetTab = (tab as HTMLElement).dataset.tab;
        tabs.forEach((t) => t.classList.remove('active'));
        contents.forEach((c) => c.classList.remove('active'));
        tab.classList.add('active');
        container.querySelector(`[data-content="${targetTab}"]`)?.classList.add('active');
      });
    });
    
    // Add param row
    const addParamBtn = container.querySelector('.playground-add-param');
    const paramsContainer = container.querySelector('.playground-params');
    addParamBtn?.addEventListener('click', () => {
      const row = document.createElement('div');
      row.className = 'playground-param-row';
      row.innerHTML = `
        <input type="text" placeholder="Key" class="playground-param-key" />
        <input type="text" placeholder="Value" class="playground-param-value" />
        <button class="playground-param-remove">×</button>
      `;
      paramsContainer?.appendChild(row);
      row.querySelector('.playground-param-remove')?.addEventListener('click', () => row.remove());
    });
    
    // Add header row
    const addHeaderBtn = container.querySelector('.playground-add-header');
    const headersContainer = container.querySelector('.playground-headers');
    addHeaderBtn?.addEventListener('click', () => {
      const row = document.createElement('div');
      row.className = 'playground-param-row';
      row.innerHTML = `
        <input type="text" placeholder="Header" class="playground-param-key" />
        <input type="text" placeholder="Value" class="playground-param-value" />
        <button class="playground-param-remove">×</button>
      `;
      headersContainer?.appendChild(row);
      row.querySelector('.playground-param-remove')?.addEventListener('click', () => row.remove());
    });
    
    // Remove buttons for initial rows
    container.querySelectorAll('.playground-param-remove').forEach((btn) => {
      btn.addEventListener('click', () => (btn as HTMLElement).closest('.playground-param-row')?.remove());
    });
    
    // Send request
    const sendBtn = container.querySelector('.playground-send-btn');
    sendBtn?.addEventListener('click', async () => {
      const baseUrl = (container.querySelector('.playground-base-url') as HTMLInputElement)?.value || '';
      let url = baseUrl + pathEl;
      
      // Collect query params
      const params: URLSearchParams = new URLSearchParams();
      container.querySelectorAll('.playground-params .playground-param-row').forEach((row) => {
        const key = (row.querySelector('.playground-param-key') as HTMLInputElement)?.value;
        const value = (row.querySelector('.playground-param-value') as HTMLInputElement)?.value;
        if (key && value) params.append(key, value);
      });
      if (params.toString()) url += '?' + params.toString();
      
      // Collect headers
      const headers: Record<string, string> = {};
      container.querySelectorAll('.playground-headers .playground-param-row').forEach((row) => {
        const key = (row.querySelector('.playground-param-key') as HTMLInputElement)?.value;
        const value = (row.querySelector('.playground-param-value') as HTMLInputElement)?.value;
        if (key && value) headers[key] = value;
      });
      
      // Get body
      const bodyInput = (container.querySelector('.playground-body-input') as HTMLTextAreaElement)?.value;
      
      const responseContainer = container.querySelector('.playground-response');
      const statusEl = container.querySelector('.playground-status');
      const timeEl = container.querySelector('.playground-time');
      const bodyEl = container.querySelector('.playground-response-body code');
      
      try {
        const startTime = performance.now();
        const response = await fetch(url, {
          method: methodEl,
          headers,
          body: ['POST', 'PUT', 'PATCH'].includes(methodEl || '') ? bodyInput : undefined,
        });
        const endTime = performance.now();
        
        const data = await response.text();
        
        responseContainer?.classList.remove('hidden');
        if (statusEl) {
          statusEl.textContent = `${response.status} ${response.statusText}`;
          statusEl.className = 'playground-status ' + (response.ok ? 'success' : 'error');
        }
        if (timeEl) timeEl.textContent = `${Math.round(endTime - startTime)}ms`;
        if (bodyEl) {
          try {
            bodyEl.textContent = JSON.stringify(JSON.parse(data), null, 2);
          } catch {
            bodyEl.textContent = data;
          }
        }
      } catch (err) {
        responseContainer?.classList.remove('hidden');
        if (statusEl) {
          statusEl.textContent = 'Error';
          statusEl.className = 'playground-status error';
        }
        if (bodyEl) bodyEl.textContent = String(err);
      }
    });
  }
  
  // Initialize all playgrounds
  document.querySelectorAll('.api-playground').forEach((el) => initPlayground(el as HTMLElement));
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.api-playground').forEach((el) => initPlayground(el as HTMLElement));
  });
</script>
