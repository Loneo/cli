---
import { getConfigFile } from '../utils/config';
import { createLink } from '../utils/url';

const { pathname } = Astro.url;
const config = await getConfigFile();

// Clean up pathname (remove trailing slash for matching)
const currentSlug = pathname.replace(/^\/|\/$/g, '');

let breadcrumbs = [];

// Always start with Home (or project name)
breadcrumbs.push({ label: 'Docs', href: '/' });

// Find current page in sidebar config
let found = false;
for (const group of config.navigation.sidebar) {
  if (found) break;
  
  // Check if it's in this group's items
  if (group.items) {
    for (const item of group.items) {
        // Handle slashes in slug comparison
       // Handle slashes in slug/href comparison
       const itemPath = item.href || item.slug || '';
       const itemSlug = itemPath.replace(/^\/|\/$/g, '');
       if (itemSlug === currentSlug) {
        breadcrumbs.push({ label: group.label }); // Group is not clickable usually
        breadcrumbs.push({ label: item.label, href: itemPath, active: true });
        found = true;
        break;
      }
    }
  }
}

// Fallback if not found (e.g. 404 or unlisted page), just show current path segments
if (!found && currentSlug) {
    const segments = currentSlug.split('/');
    segments.forEach((segment, index) => {
        const isLast = index === segments.length - 1;
        breadcrumbs.push({
            label: segment.charAt(0).toUpperCase() + segment.slice(1),
            href: isLast ? undefined : `/${segments.slice(0, index + 1).join('/')}`,
            active: isLast
        });
    });
}
---

<nav aria-label="Breadcrumb" class="mb-4 flex items-center text-sm text-muted-foreground min-h-[20px]">
  <ol class="flex items-center gap-2 flex-wrap">
    {breadcrumbs.map((item, index) => (
      <li class="flex items-center gap-2">
        {index > 0 && (
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground/50">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        )}
        
        {item.active ? (
          <span class="font-medium text-foreground" aria-current="page">
            {item.label}
          </span>
        ) : item.href ? (
          <a href={createLink(item.href)} class="hover:text-foreground transition-colors duration-200">
            {item.label}
          </a>
        ) : (
          <span>{item.label}</span>
        )}
      </li>
    ))}
  </ol>
</nav>
